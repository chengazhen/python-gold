name: æµ‹è¯•é»„é‡‘æ•°æ®è·å–

on:
  workflow_dispatch: # åªå…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œç”¨äºæµ‹è¯•

jobs:
  test-fetch:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install requests pandas openpyxl
        
    - name: æµ‹è¯•è·å–é»„é‡‘æ•°æ®
      run: |
        cd gold
        echo "ğŸ§ª å¼€å§‹æµ‹è¯•é»„é‡‘æ•°æ®è·å–..."
        python xinlang.py
        echo "âœ… æ•°æ®è·å–å®Œæˆ"
        
    - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        cd gold
        echo "ğŸ“‹ æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶:"
        
        # æ£€æŸ¥JSONæ–‡ä»¶
        for file in jewelry_gold_latest.json physical_gold_latest.json gold_bar_latest.json; do
          if [ -f "$file" ]; then
            count=$(jq length "$file" 2>/dev/null || echo "0")
            echo "âœ… $file: $count æ¡è®°å½•"
          else
            echo "âŒ $file: æ–‡ä»¶ä¸å­˜åœ¨"
          fi
        done
        
        # æ£€æŸ¥Excelæ–‡ä»¶
        if [ -f "combined_gold_data.xlsx" ]; then
          echo "âœ… combined_gold_data.xlsx: åˆå¹¶æ–‡ä»¶å·²ç”Ÿæˆ"
        else
          echo "âŒ combined_gold_data.xlsx: åˆå¹¶æ–‡ä»¶æœªç”Ÿæˆ"
        fi
        
        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        echo ""
        echo "ğŸ“Š æ–‡ä»¶å¤§å°ç»Ÿè®¡:"
        ls -lh *.json *.xlsx *.html 2>/dev/null | awk '{print $9 ": " $5}' || echo "æ²¡æœ‰æ‰¾åˆ°æ•°æ®æ–‡ä»¶"
        
    - name: éªŒè¯æ•°æ®è´¨é‡
      run: |
        cd gold
        echo "ğŸ” éªŒè¯æ•°æ®è´¨é‡..."
        
        # æ£€æŸ¥JSONæ ¼å¼æ˜¯å¦æ­£ç¡®
        for file in *_latest.json; do
          if [ -f "$file" ]; then
            if jq empty "$file" 2>/dev/null; then
              echo "âœ… $file: JSONæ ¼å¼æ­£ç¡®"
            else
              echo "âŒ $file: JSONæ ¼å¼é”™è¯¯"
            fi
          fi
        done
        
        # æ£€æŸ¥æ•°æ®æ˜¯å¦åŒ…å«å¿…è¦å­—æ®µ
        if [ -f "jewelry_gold_latest.json" ]; then
          required_fields=("æ—¥æœŸ" "å“ç‰Œ" "äº§å“" "ä»·æ ¼" "é»„é‡‘ç±»å‹")
          sample_record=$(jq '.[0]' jewelry_gold_latest.json 2>/dev/null)
          
          if [ "$sample_record" != "null" ] && [ "$sample_record" != "" ]; then
            echo "âœ… æ•°æ®è®°å½•ç¤ºä¾‹:"
            echo "$sample_record" | jq .
            
            for field in "${required_fields[@]}"; do
              if echo "$sample_record" | jq -e "has(\"$field\")" >/dev/null 2>&1; then
                echo "âœ… åŒ…å«å­—æ®µ: $field"
              else
                echo "âŒ ç¼ºå°‘å­—æ®µ: $field"
              fi
            done
          else
            echo "âŒ æ— æ³•è·å–æ•°æ®è®°å½•ç¤ºä¾‹"
          fi
        fi
        
    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      run: |
        cd gold
        echo "ğŸ“‹ ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."
        
        {
          echo "# é»„é‡‘æ•°æ®è·å–æµ‹è¯•æŠ¥å‘Š"
          echo ""
          echo "## æµ‹è¯•æ—¶é—´"
          echo "- UTCæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "- åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S' 2>/dev/null || date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "## æ•°æ®ç»Ÿè®¡"
          
          total_records=0
          for file in jewelry_gold_latest.json physical_gold_latest.json gold_bar_latest.json; do
            if [ -f "$file" ]; then
              count=$(jq length "$file" 2>/dev/null || echo "0")
              total_records=$((total_records + count))
              case "$file" in
                jewelry_gold_latest.json) echo "- é¦–é¥°é»„é‡‘: $count æ¡" ;;
                physical_gold_latest.json) echo "- å®ç‰©é»„é‡‘: $count æ¡" ;;
                gold_bar_latest.json) echo "- é‡‘æ¡: $count æ¡" ;;
              esac
            fi
          done
          
          echo "- **æ€»è®¡: $total_records æ¡è®°å½•**"
          echo ""
          echo "## ç”Ÿæˆçš„æ–‡ä»¶"
          echo "\`\`\`"
          ls -la *.json *.xlsx *.html 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°æ•°æ®æ–‡ä»¶"
          echo "\`\`\`"
          echo ""
          echo "## æµ‹è¯•ç»“æœ"
          if [ $total_records -gt 0 ]; then
            echo "âœ… **æµ‹è¯•æˆåŠŸ** - æ•°æ®è·å–æ­£å¸¸"
          else
            echo "âŒ **æµ‹è¯•å¤±è´¥** - æœªè·å–åˆ°æ•°æ®"
          fi
          
        } > test_report.md
        
        echo "ğŸ“„ æµ‹è¯•æŠ¥å‘Šå†…å®¹:"
        cat test_report.md
        
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: test-report
        path: gold/test_report.md
        
    - name: æ¸…ç†æµ‹è¯•æ–‡ä»¶
      run: |
        cd gold
        rm -f test_report.md
        echo "ğŸ§¹ æµ‹è¯•å®Œæˆï¼Œä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
